
# docker-compose.yml
#
# Production deployment manifest for the Trading Engine Services stack.
# CORRECTED to conform to the host's direct volume mount pattern for secrets.

services:
  # --------------------------------------------------------------------------
  # Core Services
  # --------------------------------------------------------------------------
  executor:
    image: your-registry/trading-engine-executor:${TAG:-latest}
    container_name: trading-engine-executor
    restart: unless-stopped
    depends_on:
      - janitor
    networks:
      - central-data-platform
    environment:
      # Non-sensitive configuration
      - SERVICE_NAME=executor
      - REDIS_HOST=redis.internal
      - POSTGRES_HOST=pgbouncer.internal
      - POSTGRES_PORT=6432
      - POSTGRES_USER=trading_app_user
      - POSTGRES_DB=trading_db
      # Environment variables pointing to the in-container paths of secrets
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - OCI_DSN_FILE=/run/secrets/oci_dsn
      - OCI_WALLET_DIR=/run/secrets/oracle_wallet
      - DERIBIT_CLIENT_ID_FILE=/run/secrets/deribit_client_id
      - DERIBIT_CLIENT_SECRET_FILE=/run/secrets/deribit_client_secret
      - JWT_PUBLIC_KEY_FILE=/run/secrets/jwt_public_key
    volumes:
      # Mount secrets directly from the host's canonical /opt/secrets directory
      - "/opt/secrets/trading_web_project_db_password.txt:/run/secrets/postgres_password:ro"
      - "/opt/secrets/oracle_db_connection_string.txt:/run/secrets/oci_dsn:ro"
      - "/opt/secrets/oracle_wallet_prod_user:/run/secrets/oracle_wallet:ro"
      - "/opt/secrets/deribit_client_id.txt:/run/secrets/deribit_client_id:ro"
      - "/opt/secrets/deribit_client_secret.txt:/run/secrets/deribit_client_secret:ro"
      - "/opt/secrets/jwt_public_key.txt:/run/secrets/jwt_public_key:ro" # Assumes this file exists
    mem_limit: 256m
    mem_reservation: 128m

  receiver:
    image: your-registry/trading-engine-receiver:${TAG:-latest}
    container_name: trading-engine-receiver
    restart: unless-stopped
    depends_on:
      - janitor
    networks:
      - central-data-platform
    environment:
      - SERVICE_NAME=receiver
      - REDIS_HOST=redis.internal
      - DERIBIT_CLIENT_ID_FILE=/run/secrets/deribit_client_id
      - DERIBIT_CLIENT_SECRET_FILE=/run/secrets/deribit_client_secret
    volumes:
      - "/opt/secrets/deribit_client_id.txt:/run/secrets/deribit_client_id:ro"
      - "/opt/secrets/deribit_client_secret.txt:/run/secrets/deribit_client_secret:ro"
    mem_limit: 384m
    mem_reservation: 256m

  distributor:
    image: your-registry/trading-engine-distributor:${TAG:-latest}
    container_name: trading-engine-distributor
    restart: unless-stopped
    depends_on:
      - janitor
    networks:
      - central-data-platform
    environment:
      - SERVICE_NAME=distributor
      - REDIS_HOST=redis.internal
      - POSTGRES_HOST=pgbouncer.internal
      - POSTGRES_PORT=6432
      - POSTGRES_USER=trading_app_user
      - POSTGRES_DB=trading_db
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    volumes:
      - "/opt/secrets/trading_web_project_db_password.txt:/run/secrets/postgres_password:ro"
    mem_limit: 384m
    mem_reservation: 256m

  analyzer:
    image: your-registry/trading-engine-analyzer:${TAG:-latest}
    container_name: trading-engine-analyzer
    restart: unless-stopped
    depends_on:
      - janitor
    networks:
      - central-data-platform
    environment:
      - SERVICE_NAME=analyzer
      - REDIS_HOST=redis.internal
    mem_limit: 256m
    mem_reservation: 128m

  janitor:
    image: your-registry/trading-engine-janitor:${TAG:-latest}
    container_name: trading-engine-janitor
    restart: unless-stopped
    networks:
      - central-data-platform
    environment:
      - SERVICE_NAME=janitor
      - REDIS_HOST=redis.internal
      - POSTGRES_HOST=pgbouncer.internal
      - POSTGRES_PORT=6432
      - POSTGRES_USER=trading_app_user
      - POSTGRES_DB=trading_db
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    volumes:
      - "/opt/secrets/trading_web_project_db_password.txt:/run/secrets/postgres_password:ro"

  # --------------------------------------------------------------------------
  # Utility & Operational Containers
  # --------------------------------------------------------------------------
  migrator:
    image: your-registry/trading-engine-migrator:${TAG:-latest}
    container_name: trading-engine-migrator
    command: tail -f /dev/null
    networks:
      - central-data-platform
    environment:
      - POSTGRES_HOST=pgbouncer.internal
      - POSTGRES_PORT=6432
      - POSTGRES_USER=trading_app_user
      - POSTGRES_DB=trading_db
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    volumes:
      - "/opt/secrets/trading_web_project_db_password.txt:/run/secrets/postgres_password:ro"

# ----------------------------------------------------------------------------
# Top-level resource definitions
# ----------------------------------------------------------------------------
networks:
  central-data-platform:
    external: true

# The 'secrets' block has been removed as it is not used in this environment.